<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz ‚Äî Rois de France (par dynastie)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --card:#0b1226cc;
      --line:#ffffff1f;
      --text:#e8eefc;
      --muted:#b7c2df;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(700px 400px at 60% 95%, rgba(245,158,11,.12), transparent 60%),
        linear-gradient(180deg, #070b16, #0b1024 65%, #070b16);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:-30px;
      pointer-events:none;
      opacity:.10;
      background-image:
        radial-gradient(circle at 15px 15px, #ffffff 0 4px, transparent 4px 100%),
        radial-gradient(circle at 15px 15px, #000000 0 7px, transparent 7px 100%),
        linear-gradient(#0b1024 0 55%, #ffffff 55% 100%);
      background-size: 80px 80px;
      transform: rotate(-4deg);
    }

    .wrap{ width:min(1120px, 100%); display:grid; gap:16px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{ display:flex; align-items:center; gap:12px; }
    .crown{
      width:44px;
      height:44px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      font-size:22px;
      line-height:1;
      transform: translateY(-1px);
    }

    .title h1{
      margin:0;
      font-family:"Press Start 2P", monospace;
      font-size:16px;
      letter-spacing:.4px;
      line-height:1.3;
    }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight:800;
      font-size:13px;
    }
    .pill strong{ color: var(--text); }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:visible;
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      flex-wrap:wrap;
    }
    .count{
      font-family:"Press Start 2P", monospace;
      font-size:14px;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:800;
    }
    .btn:hover{ background: rgba(255,255,255,.12); }
    .btn.primary{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.14);
    }
    .btn.primary:hover{ background: rgba(34,197,94,.20); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .bar{
      width:100%;
      height:14px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
      margin-top:12px;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,1), rgba(59,130,246,1));
      transition: width .25s ease;
    }

    .inputArea{ padding:16px 18px 10px; display:grid; gap:10px; }
    .inputRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{
      flex: 1 1 340px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    input:focus{ border-color: rgba(59,130,246,.6); box-shadow: 0 0 0 4px rgba(59,130,246,.18); }

    .hint{
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      padding:0 18px 12px;
    }
    .toast{ min-height:18px; font-weight:800; font-size:13px; padding:0 18px 14px; }
    .toast.good{ color: var(--good); }
    .toast.warn{ color: var(--warn); }
    .toast.bad{ color: var(--bad); }

    .gridWrap{ padding: 0 18px 18px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap:12px;
      max-height: 560px;
      overflow:auto;
      padding-right: 6px;
    }

    /* Group header inside the grid */
    .group{
      grid-column: 1 / -1;
      border:1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(59,130,246,.16), rgba(34,197,94,.10) 70%, rgba(0,0,0,.10));
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .group .gName{
      font-family:"Press Start 2P", monospace;
      font-size:12px;
      letter-spacing:.35px;
      line-height:1.25;
    }
    .group .gRange{
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }

    .cell{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .cell:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }

    .cell.found{
      color: var(--text);
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }

    .cell.revealed{
      color: var(--text);
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }
    .cell.revealed .name{
      color: var(--bad);
      font-weight: 900;
    }

    .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .num{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      border-radius:10px;
      padding:3px 7px;
      color: var(--text);
      min-width:92px;
      text-align:center;
      flex: 0 0 auto;
    }

    .name{
      font-weight:800;
      color: inherit;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.15;
      display:block;
    }

    /* ‚úÖ Fun fact */
    .info{
      margin-top:4px;
      font-size:12px;
      line-height:1.25;
      color: var(--muted);
      opacity:.95;
    }
    .cell.found .info{ color: rgba(232,238,252,.92); }
    /* ‚úÖ CHANGEMENT : on n'enterre plus les facts en mode revealed */
    .cell.revealed .info{
      display:block;
      color: rgba(183,194,223,.95);
      opacity:.95;
    }

    .status{
      flex: 0 0 auto;
      font-size: 14px;
      opacity:.9;
      white-space:nowrap;
    }

    .masked{
      letter-spacing:.6px;
      font-weight:700;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="crown" aria-hidden="true">üëë</div>
        <div class="title">
          <h1>Quiz ‚Äî Rois de France</h1>
          <p>Par dynastie ¬∑ fun facts + emoji</p>
        </div>
      </div>

      <div class="meta">
        <button class="btn" id="btnHome">üè† Accueil</button>
        <div class="pill">‚è±Ô∏è Temps : <strong id="timer">00:00</strong></div>
        <div class="pill">üéØ Score : <strong id="score">0</strong>/<strong id="total">0</strong></div>
        <button class="btn" id="btnPause">‚è∏Ô∏è Pause</button>
        <button class="btn primary" id="btnReset">üîÑ Recommencer</button>
        <button class="btn" id="btnGiveUp">üè≥Ô∏è Abandonner</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="count" id="count">0 / 0</div>
          <div class="bar"><div class="fill" id="fill"></div></div>
        </div>
        <div class="hint" style="padding:0; max-width:660px;">
          ‚úÖ <strong>Ordre libre</strong> ‚Äî tu peux taper un roi dans n‚Äôimporte quel ordre.
          <span style="display:inline-block; opacity:.9"> (ex : ‚ÄúLouis 14‚Äù, ‚ÄúLouis XIV‚Äù, ‚ÄúSaint Louis‚Äù, ‚ÄúCharles le Chauve‚Äù‚Ä¶)</span>
        </div>
      </div>

      <div class="inputArea">
        <div class="inputRow">
          <input id="input" type="text" placeholder="Tape un roi de France‚Ä¶" autocomplete="off" />
          <button class="btn" id="btnSubmit">‚úÖ Valider</button>
        </div>
      </div>
      <div id="toast" class="toast"></div>

      <div class="gridWrap">
        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>

<script>
  // --------- Utils ----------
  function normalize(str) {
    return (str || "")
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/≈ì/g,"oe")
      .replace(/√¶/g,"ae")
      .replace(/[^a-z0-9]/g, "");
  }

  // Roman helpers (pour accepter XIV / 14, etc.)
  const romanMap = { I:1, V:5, X:10, L:50, C:100, D:500, M:1000 };
  function romanToInt(roman){
    if(!roman) return null;
    roman = roman.toUpperCase().replace(/[^IVXLCDM]/g,"");
    if(!roman) return null;
    let total = 0, prev = 0;
    for(let i=roman.length-1;i>=0;i--){
      const v = romanMap[roman[i]] || 0;
      if(v < prev) total -= v; else total += v;
      prev = v;
    }
    return total || null;
  }
  function intToRoman(num){
    if(!num || num<=0 || num>3999) return "";
    const vals = [
      [1000,"M"],[900,"CM"],[500,"D"],[400,"CD"],
      [100,"C"],[90,"XC"],[50,"L"],[40,"XL"],
      [10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]
    ];
    let n=num, out="";
    for(const [v,s] of vals){
      while(n>=v){ out+=s; n-=v; }
    }
    return out;
  }

  // --------- Data ----------
  // id: unique (dynastie + d√©but) / label: affichage court
  // king: nom affich√© / reign: ann√©es / fact: fun fact + emoji
  const dynasties = [
    {
      id:"merovingiens",
      name:"M√©rovingiens",
      range:"(458‚Äì751)",
      kings:[
        { id:"mer-0458-childeric1", label:"458", king:"Child√©ric I", reign:"458‚Äì481", fact:"ü™ô Son tombeau (Tournai) a livr√© un tr√©sor c√©l√®bre‚Ä¶ avec des abeilles en or !" },
        { id:"mer-0481-clovis1",    label:"481", king:"Clovis I",    reign:"481‚Äì511", fact:"‚õ™ Baptis√© √† Reims : un tournant majeur pour le royaume des Francs." },
        { id:"mer-0511-clotaire1",  label:"511", king:"Clotaire I",  reign:"511‚Äì561", fact:"üß© Il finit par r√©unifier une grande partie du royaume franc." },
        { id:"mer-0561-charibert1", label:"561", king:"Caribert I",  reign:"561‚Äì567", fact:"‚è≥ R√®gne tr√®s court : l‚Äô√©poque est un vrai puzzle dynastique." },
        { id:"mer-0561-sigebert1",  label:"561", king:"Sigebert I",  reign:"561‚Äì575", fact:"üõ°Ô∏è Roi d‚ÄôAustrasie : une des grandes ‚ÄúFrance‚Äù de l‚Äô√©poque m√©rovingienne." },
        { id:"mer-0561-chilperic1", label:"561", king:"Chilp√©ric I", reign:"561‚Äì584", fact:"‚öîÔ∏è Rivalit√©s et intrigues : on est en plein feuilleton politique." },
        { id:"mer-0575-childebert2",label:"575", king:"Childebert II",reign:"575‚Äì596", fact:"üëë H√©ritages et partages : il r√©cup√®re plusieurs territoires au fil du temps." },
        { id:"mer-0584-clotaire2",  label:"584", king:"Clotaire II", reign:"584‚Äì629", fact:"üìú L‚Äô√©dit de Paris (614) est un texte cl√© pour l‚Äôorganisation du royaume." },
        { id:"mer-0629-dagobert1",  label:"629", king:"Dagobert I",  reign:"629‚Äì639", fact:"üé∂ ‚ÄúLe bon roi Dagobert‚Äù : sa c√©l√©brit√© pop d√©passe largement son √©poque !" },
        { id:"mer-0639-clovis2",    label:"639", king:"Clovis II",   reign:"639‚Äì657", fact:"üèõÔ∏è √Ä cette p√©riode, les ‚Äúmaires du palais‚Äù deviennent ultra-puissants." },
        { id:"mer-0662-childeric2", label:"662", king:"Child√©ric II",reign:"662‚Äì675", fact:"üåÄ R√®gne bref : instabilit√© et luttes d‚Äôinfluence en coulisses." },
        { id:"mer-0679-theuderic3", label:"679", king:"Thierry III", reign:"679‚Äì691", fact:"üß† P√©riode souvent associ√©e aux ‚Äúrois fain√©ants‚Äù (pouvoir tr√®s encadr√©)." },
        { id:"mer-0691-clovis3",    label:"691", king:"Clovis III",  reign:"691‚Äì695", fact:"‚è±Ô∏è Quelques ann√©es seulement : record de ‚Äúspeed-run‚Äù royal." },
        { id:"mer-0695-childebert3",label:"695", king:"Childebert III",reign:"695‚Äì711", fact:"üß≤ Fin de dynastie : les Carolingiens prennent d√©j√† toute la place." },
        { id:"mer-0711-dagobert3",  label:"711", king:"Dagobert III",reign:"711‚Äì715", fact:"‚ö° R√®gne √©clair : la transition vers les Carolingiens s‚Äôacc√©l√®re." },
        { id:"mer-0715-chilperic2", label:"715", king:"Chilp√©ric II",reign:"715‚Äì721", fact:"üß® √âpoque li√©e √† la mont√©e en puissance de Charles Martel (en arri√®re-plan)." },
        { id:"mer-0721-theuderic4", label:"721", king:"Thierry IV",  reign:"721‚Äì737", fact:"üåí Derniers M√©rovingiens : le pouvoir r√©el est ailleurs." },
        { id:"mer-0743-childeric3", label:"743", king:"Child√©ric III",reign:"743‚Äì751", fact:"üö™ Dernier M√©rovingien : d√©pos√© par P√©pin le Bref." },
      ]
    },
    {
      id:"carolingiens",
      name:"Carolingiens",
      range:"(751‚Äì987)",
      kings:[
        { id:"car-0751-pepin",      label:"751", king:"P√©pin le Bref",        reign:"751‚Äì768", fact:"üõê Son sacre assoit une nouvelle dynastie : les Carolingiens." },
        { id:"car-0768-charlemagne",label:"768", king:"Charlemagne",           reign:"768‚Äì814", fact:"üëë Couronn√© empereur en 800 : une date ‚Äúwaouh‚Äù de l‚Äôhistoire europ√©enne." },
        { id:"car-0814-louis1",     label:"814", king:"Louis I le Pieux",      reign:"814‚Äì840", fact:"üßæ Son r√®gne ouvre une p√©riode de partages‚Ä¶ et de tensions familiales." },
        { id:"car-0843-charles2",   label:"843", king:"Charles II le Chauve",  reign:"843‚Äì877", fact:"üó∫Ô∏è Trait√© de Verdun (843) : la Francie occidentale prend forme." },
        { id:"car-0877-louis2",     label:"877", king:"Louis II le B√®gue",     reign:"877‚Äì879", fact:"üó£Ô∏è Son surnom est l‚Äôun des plus m√©morables (et un peu cruel‚Ä¶)." },
        { id:"car-0879-louis3",     label:"879", king:"Louis III",             reign:"879‚Äì882", fact:"‚ö° R√®gne tr√®s court : 3 ans et puis s‚Äôen va." },
        { id:"car-0879-carloman2",  label:"879", king:"Carloman II",           reign:"879‚Äì884", fact:"ü§ù Il r√®gne au d√©part en parall√®le : duo royal dans une p√©riode tendue." },
        { id:"car-0884-charles3",   label:"884", king:"Charles III le Gros",   reign:"884‚Äì888", fact:"üß© Dernier √† r√©unir bri√®vement un immense ensemble carolingien." },
        { id:"car-0888-eudes",      label:"888", king:"Eudes",                 reign:"888‚Äì898", fact:"üè∞ H√©ros de la d√©fense de Paris face aux Vikings." },
        { id:"car-0898-charles3simple",label:"898", king:"Charles III le Simple", reign:"898‚Äì922", fact:"üõ∂ 911 : trait√© √† l‚Äôorigine de la Normandie (et des Normands) !" },
        { id:"car-0922-robert1",    label:"922", king:"Robert I",              reign:"922‚Äì923", fact:"üó≥Ô∏è √âlu contre Charles le Simple : la royaut√© devient tr√®s disput√©e." },
        { id:"car-0923-raoul",      label:"923", king:"Raoul",                 reign:"923‚Äì936", fact:"üç∑ Duc de Bourgogne devenu roi : le poids des grands seigneurs explose." },
        { id:"car-0936-louis4",     label:"936", king:"Louis IV d‚ÄôOutremer",   reign:"936‚Äì954", fact:"üåä ‚ÄúD‚ÄôOutremer‚Äù car il a grandi en Angleterre. International avant l‚Äôheure !" },
        { id:"car-0954-lothaire",   label:"954", king:"Lothaire",              reign:"954‚Äì986", fact:"üß± √âpoque de rivalit√©s entre princes : le roi doit ‚Äún√©gocier‚Äù sans cesse." },
        { id:"car-0986-louis5",     label:"986", king:"Louis V",               reign:"986‚Äì987", fact:"üß® Dernier Carolingien : apr√®s lui, place aux Cap√©tiens." },
      ]
    },
    {
      id:"capetiens",
      name:"Cap√©tiens",
      range:"(987‚Äì1328)",
      kings:[
        { id:"cap-0987-hugues",     label:"987", king:"Hugues Capet",          reign:"987‚Äì996", fact:"üîë Il lance une dynastie qui va durer‚Ä¶ des si√®cles." },
        { id:"cap-0996-robert2",    label:"996", king:"Robert II le Pieux",    reign:"996‚Äì1031", fact:"‚õ™ Surnom ‚Äúle Pieux‚Äù : il est tr√®s li√© aux r√©formes religieuses." },
        { id:"cap-1031-henri1",     label:"1031",king:"Henri I",               reign:"1031‚Äì1060", fact:"üß≠ Consolide l‚Äôautorit√© royale dans un royaume tr√®s f√©odal." },
        { id:"cap-1060-philippe1",  label:"1060",king:"Philippe I",            reign:"1060‚Äì1108", fact:"üßí Roi tr√®s jeune : il r√®gne d‚Äôabord sous r√©gence." },
        { id:"cap-1108-louis6",     label:"1108",king:"Louis VI le Gros",      reign:"1108‚Äì1137", fact:"üõ°Ô∏è Il s‚Äôattaque aux seigneurs turbulents : ‚Äúpolice‚Äù du royaume." },
        { id:"cap-1137-louis7",     label:"1137",king:"Louis VII le Jeune",    reign:"1137‚Äì1180", fact:"‚öîÔ∏è Il participe √† la 2e croisade (et √ßa secoue son r√®gne)." },
        { id:"cap-1180-philippe2",  label:"1180",king:"Philippe II Auguste",  reign:"1180‚Äì1223", fact:"üè∞ Il reprend de vastes territoires aux Plantagen√™ts (Angleterre)." },
        { id:"cap-1223-louis8",     label:"1223",king:"Louis VIII le Lion",    reign:"1223‚Äì1226", fact:"ü¶Å ‚ÄúLe Lion‚Äù : surnom badass pour un r√®gne tr√®s court." },
        { id:"cap-1226-louis9",     label:"1226",king:"Louis IX (Saint Louis)",reign:"1226‚Äì1270", fact:"‚öñÔ∏è Symbole de justice : l‚Äôimage du roi rendant justice sous un ch√™ne." },
        { id:"cap-1270-philippe3",  label:"1270",king:"Philippe III le Hardi",reign:"1270‚Äì1285", fact:"üèá ‚ÄúLe Hardi‚Äù : courageux‚Ä¶ m√™me si son r√®gne reste discret." },
        { id:"cap-1285-philippe4",  label:"1285",king:"Philippe IV le Bel",   reign:"1285‚Äì1314", fact:"üî• Bras de fer avec le pape + fin des Templiers : r√®gne explosif." },
        { id:"cap-1314-louis10",    label:"1314",king:"Louis X le Hutin",      reign:"1314‚Äì1316", fact:"üç∑ Surnom ‚Äúle Hutin‚Äù = querelleur : ambiance tendue au sommet." },
        { id:"cap-1316-jean1",      label:"1316",king:"Jean I le Posthume",   reign:"1316", fact:"üë∂ Roi-nourrisson : un des r√®gnes les plus courts de l‚Äôhistoire." },
        { id:"cap-1316-philippe5",  label:"1316",king:"Philippe V le Long",   reign:"1316‚Äì1322", fact:"üìè ‚ÄúLe Long‚Äù : un surnom qui a travers√© les si√®cles." },
        { id:"cap-1322-charles4",   label:"1322",king:"Charles IV le Bel",    reign:"1322‚Äì1328", fact:"üß¨ Dernier Cap√©tien direct : apr√®s lui, changement de branche !" },
      ]
    },
    {
      id:"valois",
      name:"Valois",
      range:"(1328‚Äì1589)",
      kings:[
        { id:"val-1328-philippe6",  label:"1328",king:"Philippe VI",           reign:"1328‚Äì1350", fact:"‚öîÔ∏è D√©but de la guerre de Cent Ans : √ßa part tr√®s fort." },
        { id:"val-1350-jean2",      label:"1350",king:"Jean II le Bon",        reign:"1350‚Äì1364", fact:"üé≠ Captur√© √† Poitiers : un roi prisonnier, √ßa marque l‚Äô√©poque." },
        { id:"val-1364-charles5",   label:"1364",king:"Charles V le Sage",     reign:"1364‚Äì1380", fact:"üß† ‚ÄúLe Sage‚Äù : gros travail de redressement apr√®s des crises." },
        { id:"val-1380-charles6",   label:"1380",king:"Charles VI",            reign:"1380‚Äì1422", fact:"üåÄ Surnomm√© ‚Äúle Fou‚Äù : son r√®gne est marqu√© par de graves troubles." },
        { id:"val-1422-charles7",   label:"1422",king:"Charles VII",           reign:"1422‚Äì1461", fact:"üïäÔ∏è Jeanne d‚ÄôArc change la donne : Reims, sacre, et regain." },
        { id:"val-1461-louis11",    label:"1461",king:"Louis XI",              reign:"1461‚Äì1483", fact:"üï∏Ô∏è ‚ÄúL‚Äôuniverselle araigne‚Äù : ma√Ætre des intrigues et de la diplomatie." },
        { id:"val-1483-charles8",   label:"1483",king:"Charles VIII",          reign:"1483‚Äì1498", fact:"üáÆüáπ Il lance les guerres d‚ÄôItalie : la France regarde vers la Renaissance." },
        { id:"val-1498-louis12",    label:"1498",king:"Louis XII",             reign:"1498‚Äì1515", fact:"‚ù§Ô∏è Surnomm√© ‚ÄúP√®re du peuple‚Äù : image de roi proche et populaire." },
        { id:"val-1515-francois1",  label:"1515",king:"Fran√ßois I",            reign:"1515‚Äì1547", fact:"üé® Renaissance XXL : L√©onard de Vinci vient en France sous son r√®gne." },
        { id:"val-1547-henri2",     label:"1547",king:"Henri II",              reign:"1547‚Äì1559", fact:"üèüÔ∏è Passionn√© de tournois‚Ä¶ et un accident fatal lors d‚Äôune joute." },
        { id:"val-1559-francois2",  label:"1559",king:"Fran√ßois II",           reign:"1559‚Äì1560", fact:"‚è±Ô∏è R√®gne √©clair : 1 an, et la crise religieuse s‚Äôintensifie." },
        { id:"val-1560-charles9",   label:"1560",king:"Charles IX",            reign:"1560‚Äì1574", fact:"ü©∏ Guerres de Religion : son r√®gne reste associ√© √† une France d√©chir√©e." },
        { id:"val-1574-henri3",     label:"1574",king:"Henri III",             reign:"1574‚Äì1589", fact:"üó°Ô∏è Fin tragique : assassin√©, au c≈ìur des tensions de l‚Äô√©poque." },
      ]
    },
    {
      id:"bourbons",
      name:"Bourbons",
      range:"(1589‚Äì1792)",
      kings:[
        { id:"bou-1589-henri4",     label:"1589",king:"Henri IV",              reign:"1589‚Äì1610", fact:"üåæ ‚ÄúPoulet au pot‚Äù : la punchline sociale la plus c√©l√®bre de la monarchie." },
        { id:"bou-1610-louis13",    label:"1610",king:"Louis XIII",            reign:"1610‚Äì1643", fact:"üÉè Richelieu, mousquetaires‚Ä¶ une √©poque qui a inspir√© mille r√©cits !" },
        { id:"bou-1643-louis14",    label:"1643",king:"Louis XIV",             reign:"1643‚Äì1715", fact:"‚òÄÔ∏è ‚ÄúRoi-Soleil‚Äù + Versailles : le r√®gne-symbole de l‚Äôabsolutisme." },
        { id:"bou-1715-louis15",    label:"1715",king:"Louis XV",              reign:"1715‚Äì1774", fact:"üïØÔ∏è Long r√®gne, mais une popularit√© qui s‚Äôeffrite (et pr√©pare la suite‚Ä¶)." },
        { id:"bou-1774-louis16",    label:"1774",king:"Louis XVI",             reign:"1774‚Äì1792", fact:"üá∫üá∏ Soutien aux Am√©ricains‚Ä¶ puis la R√©volution bouleverse tout." },
      ]
    },
    {
      id:"restauration",
      name:"Restauration",
      range:"(1814‚Äì1830)",
      kings:[
        { id:"res-1814-louis18",    label:"1814",king:"Louis XVIII",            reign:"1814‚Äì1824 (interruption 1815)", fact:"üß© Retour de la monarchie apr√®s Napol√©on : p√©riode ultra-politique." },
        { id:"res-1824-charles10",  label:"1824",king:"Charles X",              reign:"1824‚Äì1830", fact:"üì£ Ses ordonnances d√©clenchent la R√©volution de 1830." },
      ]
    },
    {
      id:"orleans",
      name:"Orl√©ans",
      range:"(1830‚Äì1848)",
      kings:[
        { id:"orl-1830-louisphilippe1",label:"1830",king:"Louis-Philippe I",    reign:"1830‚Äì1848", fact:"üß¢ ‚ÄúRoi des Fran√ßais‚Äù (et pas ‚Äúroi de France‚Äù) : d√©tail qui change tout." },
      ]
    }
  ];

  // Flatten
  const kings = [];
  for (const d of dynasties) for (const k of d.kings) kings.push({ ...k, dynastyId:d.id });

  const TOTAL = kings.length;

  // Index
  const byId = new Map();
  const byKey = new Map(); // key -> id (canonical)
  const allKeys = new Set();

  function addKey(key, id){
    if(!key) return;
    const k = normalize(key);
    if(!k) return;
    allKeys.add(k);
    if(!byKey.has(k)) byKey.set(k, id);
  }

  for (const k of kings) {
    byId.set(k.id, k);

    // Canonical
    addKey(k.king, k.id);

    // Variantes simples (sans parenth√®ses / surnoms)
    const paren = k.king.match(/^(.+?)\s*\((.+)\)\s*$/);
    if (paren) {
      addKey(paren[1], k.id);
      addKey(paren[2], k.id);
    }

    // Variantes chiffres/romains
    const m = k.king.match(/^(.*?)(\s+)([IVXLCDM]+|\d+)\s*$/i);
    if (m) {
      const base = m[1].trim();
      const rawNum = m[3].trim();

      const asInt = /^\d+$/.test(rawNum) ? parseInt(rawNum,10) : romanToInt(rawNum);
      if (asInt) {
        const roman = intToRoman(asInt);
        addKey(`${base} ${roman}`, k.id);
        addKey(`${base} ${asInt}`, k.id);
        addKey(`${base}${asInt}`, k.id);
        addKey(`${base}${roman}`, k.id);

        if (asInt === 1) {
          addKey(`${base} 1er`, k.id);
          addKey(`${base} ier`, k.id);
          addKey(`${base} premier`, k.id);
        }
      }
      addKey(base, k.id);
    } else {
      addKey(k.king.replace(/\bIer\b/gi,"I"), k.id);
      addKey(k.king.replace(/\bI\b/gi,"1"), k.id);
    }

    // Alias ‚Äú√† la main‚Äù
    const manual = new Map([
      ["saintlouis","louisix"],
      ["philippeauguste","philippeii"],
      ["louisdoutremer","louisiv"],
      ["charleslechauve","charlesii"],
      ["charleslegros","charlesiii"],
      ["charleslesimple","charlesiii"],
      ["robertlepieus","robertii"],
      ["lebel","philippeiv"],
      ["roisoleil","louisxiv"],
    ]);
    for (const [alias, token] of manual.entries()) {
      const curKey = normalize(k.king);
      if (curKey.includes(token)) addKey(alias, k.id);
    }
  }

  // --------- State ----------
  const foundIds = new Set();
  let timerInterval = null;
  let startTs = null;
  let elapsedMs = 0;
  let isPaused = false;
  let isFinished = false;
  let isGivenUp = false;

  // --------- Timer ----------
  const timerEl = document.getElementById("timer");
  const btnPause = document.getElementById("btnPause");

  function fmtTimeFromMs(ms) {
    const seconds = Math.floor(ms / 1000);
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function renderTimer() {
    timerEl.textContent = fmtTimeFromMs(elapsedMs + (startTs ? (Date.now() - startTs) : 0));
  }
  function stopTimerIntervalOnly() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
  }
  function startTimerIfNeeded() {
    if (isFinished || isPaused || isGivenUp) return;
    if (timerInterval) return;
    if (!startTs) startTs = Date.now();
    timerInterval = setInterval(renderTimer, 250);
  }
  function stopTimer() {
    if (startTs) { elapsedMs += (Date.now() - startTs); startTs = null; }
    stopTimerIntervalOnly();
    renderTimer();
  }
  function resetTimer() {
    stopTimerIntervalOnly();
    startTs = null;
    elapsedMs = 0;
    isPaused = false;
    isFinished = false;
    isGivenUp = false;
    btnPause.disabled = false;
    btnPause.textContent = "‚è∏Ô∏è Pause";
    timerEl.textContent = "00:00";
  }
  function pauseTimer() {
    if (isFinished || isGivenUp || isPaused) return;
    if (startTs) { elapsedMs += (Date.now() - startTs); startTs = null; }
    stopTimerIntervalOnly();
    isPaused = true;
    btnPause.textContent = "‚ñ∂Ô∏è Reprendre";
    setToast("warn", "‚è∏Ô∏è Timer en pause.");
  }
  function resumeTimer() {
    if (isFinished || isGivenUp || !isPaused) return;
    isPaused = false;
    startTs = Date.now();
    btnPause.textContent = "‚è∏Ô∏è Pause";
    setToast("", "");
    startTimerIfNeeded();
  }
  function togglePause() {
    if (isFinished || isGivenUp) return;
    if (isPaused) resumeTimer(); else pauseTimer();
  }

  // --------- UI ----------
  const input = document.getElementById("input");
  const toast = document.getElementById("toast");
  const countEl = document.getElementById("count");
  const fillEl = document.getElementById("fill");
  const gridEl = document.getElementById("grid");
  const scoreEl = document.getElementById("score");
  const totalEl = document.getElementById("total");
  const btnGiveUp = document.getElementById("btnGiveUp");
  const btnSubmit = document.getElementById("btnSubmit");

  function setToast(type, msg) {
    toast.className = "toast " + (type || "");
    toast.textContent = msg || "";
  }

  function updateStats() {
    const n = foundIds.size;
    countEl.textContent = `${n} / ${TOTAL}`;
    scoreEl.textContent = n;
    totalEl.textContent = TOTAL;
    fillEl.style.width = `${(n / TOTAL) * 100}%`;
  }

  function buildGrid() {
    gridEl.innerHTML = "";

    for (const d of dynasties) {
      const g = document.createElement("div");
      g.className = "group";
      g.innerHTML = `
        <div class="gName">üëë ${d.name}</div>
        <div class="gRange">${d.range}</div>
      `;
      gridEl.appendChild(g);

      for (const k of d.kings) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.id = `cell-${k.id}`;
        cell.innerHTML = `
          <div class="left">
            <div class="num">${k.label}</div>
            <div style="min-width:0">
              <div class="name masked" id="name-${k.id}">??????</div>
              <div class="info" id="info-${k.id}" style="display:none;"></div>
            </div>
          </div>
          <div class="status" id="status-${k.id}">‚Äî</div>
        `;
        gridEl.appendChild(cell);
      }
    }
  }

  function revealId(id, mode /* "found" | "revealed" */) {
    const k = byId.get(id);
    if (!k) return;

    const cell = document.getElementById(`cell-${k.id}`);
    const nameEl = document.getElementById(`name-${k.id}`);
    const infoEl = document.getElementById(`info-${k.id}`);
    const statusEl = document.getElementById(`status-${k.id}`);

    cell.classList.add(mode === "found" ? "found" : "revealed");
    cell.classList.remove(mode === "found" ? "revealed" : "found");

    nameEl.textContent = `${k.king} ‚Äî ${k.reign}`;
    nameEl.classList.remove("masked");

    /* ‚úÖ CHANGEMENT : on affiche le fun fact aussi en "revealed" */
    infoEl.style.display = "block";
    infoEl.textContent = k.fact ? `üí° ${k.fact}` : "üí° ‚Äî";

    statusEl.textContent = mode === "found" ? "‚úÖ" : "‚ùå";
  }

  function revealMissingSolutions() {
    for (const k of kings) {
      if (foundIds.has(k.id)) continue;
      revealId(k.id, "revealed");
    }
  }

  function giveUp() {
    if (isFinished || isGivenUp) return;

    isGivenUp = true;
    stopTimer();

    btnPause.disabled = true;
    btnPause.textContent = "‚èπÔ∏è Stop";
    input.disabled = true;
    btnSubmit.disabled = true;

    revealMissingSolutions();

    const n = foundIds.size;
    setToast("bad", `üè≥Ô∏è Abandon : ${n}/${TOTAL} trouv√©s en ${timerEl.textContent}. Solutions + faits affich√©s en rouge.`);
  }

  function finish() {
    isFinished = true;
    stopTimer();

    btnPause.disabled = true;
    btnPause.textContent = "üèÅ Termin√©";
    btnGiveUp.disabled = true;
    input.disabled = true;
    btnSubmit.disabled = true;

    setToast("good", `üèÜ ${TOTAL}/${TOTAL} ! Liste compl√©t√©e en ${timerEl.textContent} !`);
  }

  function tryFindKing(raw){
    const norm = normalize(raw);
    if(!norm) return null;

    if (byKey.has(norm)) return byKey.get(norm);

    const compact = norm.replace(/[^a-z0-9]/g,"");
    if (byKey.has(compact)) return byKey.get(compact);

    return null;
  }

  function validate(raw) {
    const id = tryFindKing(raw);
    if (!id) {
      setToast("bad", "‚ùå Roi non reconnu (ou orthographe non reconnue).");
      return { ok:false };
    }
    if (foundIds.has(id)) {
      setToast("warn", "‚ö†Ô∏è D√©j√† trouv√© !");
      return { ok:false };
    }

    startTimerIfNeeded();

    foundIds.add(id);
    revealId(id, "found");
    updateStats();

    const k = byId.get(id);
    setToast("good", `‚úÖ ${k.king} (${k.reign}) ‚Äî üí° ${k.fact}`);

    const cell = document.getElementById(`cell-${id}`);
    cell && cell.animate(
      [{ transform:"translateY(0)" }, { transform:"translateY(-2px)" }, { transform:"translateY(0)" }],
      { duration: 160, easing: "ease-out" }
    );

    if (foundIds.size === TOTAL) finish();
    return { ok:true };
  }

  function submit() {
    if (isGivenUp) {
      setToast("warn", "üè≥Ô∏è Partie abandonn√©e. Clique sur ¬´ Recommencer ¬ª pour rejouer.");
      input.value = "";
      return;
    }
    if (isPaused) {
      setToast("warn", "‚è∏Ô∏è Le timer est en pause. Clique sur ¬´ Reprendre ¬ª pour continuer.");
      input.value = "";
      input.focus();
      return;
    }

    const raw = input.value;
    input.value = "";
    input.focus();

    const norm = normalize(raw);
    if (!norm) { setToast("warn", "‚ö†Ô∏è Tape un nom."); return; }

    validate(raw);
  }

  function resetQuiz() {
    foundIds.clear();

    buildGrid();
    updateStats();
    setToast("", "");
    resetTimer();

    input.disabled = false;
    btnSubmit.disabled = false;
    btnGiveUp.disabled = false;

    input.value = "";
    input.focus();
  }

  // ‚úÖ Auto-validation (exact match seulement ; √©vite les pr√©fixes)
  let autoT = null;

  function isAnyPrefix(typedKey){
    if (!typedKey) return false;
    for (const k of allKeys) {
      if (k.startsWith(typedKey) && k !== typedKey) return true;
    }
    return false;
  }

  function autoTryValidate() {
    if (isPaused || isFinished || isGivenUp) return;

    const raw = input.value;
    const norm = normalize(raw);
    if (!norm) return;

    if (isAnyPrefix(norm)) return;

    if (byKey.has(norm)) {
      input.value = "";
      validate(raw);
      input.focus();
      return;
    }
  }

  input.addEventListener("input", () => {
    clearTimeout(autoT);
    autoT = setTimeout(autoTryValidate, 120);
  });

  // Events
  btnSubmit.addEventListener("click", submit);
  document.getElementById("btnReset").addEventListener("click", resetQuiz);
  btnPause.addEventListener("click", togglePause);
  btnGiveUp.addEventListener("click", giveUp);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });

  const btnHome = document.getElementById("btnHome");
  btnHome.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  // init
  buildGrid();
  updateStats();
  input.focus();
</script>
</body>
</html>