<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz ‚Äî Rois & Reines (Angleterre ‚Üí Royaume-Uni) (par dynastie)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --card:#0b1226cc;
      --line:#ffffff1f;
      --text:#e8eefc;
      --muted:#b7c2df;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(700px 400px at 60% 95%, rgba(245,158,11,.12), transparent 60%),
        linear-gradient(180deg, #070b16, #0b1024 65%, #070b16);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:-30px;
      pointer-events:none;
      opacity:.10;
      background-image:
        radial-gradient(circle at 15px 15px, #ffffff 0 4px, transparent 4px 100%),
        radial-gradient(circle at 15px 15px, #000000 0 7px, transparent 7px 100%),
        linear-gradient(#0b1024 0 55%, #ffffff 55% 100%);
      background-size: 80px 80px;
      transform: rotate(-4deg);
    }

    .wrap{ width:min(1120px, 100%); display:grid; gap:16px; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{ display:flex; align-items:center; gap:12px; }
    .crown{
      width:44px;
      height:44px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      font-size:22px;
      line-height:1;
      transform: translateY(-1px);
    }

    .title h1{
      margin:0;
      font-family:"Press Start 2P", monospace;
      font-size:16px;
      letter-spacing:.4px;
      line-height:1.3;
    }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight:800;
      font-size:13px;
    }
    .pill strong{ color: var(--text); }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:visible;
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      flex-wrap:wrap;
    }
    .count{
      font-family:"Press Start 2P", monospace;
      font-size:14px;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:800;
    }
    .btn:hover{ background: rgba(255,255,255,.12); }
    .btn.primary{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.14);
    }
    .btn.primary:hover{ background: rgba(34,197,94,.20); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .bar{
      width:100%;
      height:14px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
      margin-top:12px;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,1), rgba(59,130,246,1));
      transition: width .25s ease;
    }

    .inputArea{ padding:16px 18px 10px; display:grid; gap:10px; }
    .inputRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{
      flex: 1 1 340px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    input:focus{ border-color: rgba(59,130,246,.6); box-shadow: 0 0 0 4px rgba(59,130,246,.18); }

    .hint{
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      padding:0 18px 12px;
    }
    .toast{ min-height:18px; font-weight:800; font-size:13px; padding:0 18px 14px; }
    .toast.good{ color: var(--good); }
    .toast.warn{ color: var(--warn); }
    .toast.bad{ color: var(--bad); }

    .gridWrap{ padding: 0 18px 18px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap:12px;
      max-height: 560px;
      overflow:auto;
      padding-right: 6px;
    }

    .group{
      grid-column: 1 / -1;
      border:1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(59,130,246,.16), rgba(34,197,94,.10) 70%, rgba(0,0,0,.10));
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .group .gName{
      font-family:"Press Start 2P", monospace;
      font-size:12px;
      letter-spacing:.35px;
      line-height:1.25;
    }
    .group .gRange{
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .gCount{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      font-weight:800;
      padding:3px 8px;
      border-radius:8px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      color:var(--muted);
      white-space:nowrap;
      transition:color .3s;
    }

    .cell{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .cell:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }

    .cell.found{
      color: var(--text);
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
    }

    .cell.revealed{
      color: var(--text);
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }
    .cell.revealed .name{
      color: var(--bad);
      font-weight: 900;
    }

    .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .num{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.2);
      border-radius:10px;
      padding:3px 7px;
      color: var(--text);
      min-width:92px;
      text-align:center;
      flex: 0 0 auto;
    }

    .name{
      font-weight:800;
      color: inherit;
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.15;
      display:block;
    }

    .info{
      margin-top:4px;
      font-size:12px;
      line-height:1.25;
      color: var(--muted);
      opacity:.95;
    }
    .cell.found .info{ color: rgba(232,238,252,.92); }
    .cell.revealed .info{
      display:block;
      color: rgba(183,194,223,.95);
      opacity:.95;
    }

    .status{
      flex: 0 0 auto;
      font-size: 14px;
      opacity:.9;
      white-space:nowrap;
    }

    .masked{
      letter-spacing:.6px;
      font-weight:700;
      color: var(--muted);
    }
    .cell.hinted{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.07);
    }
    .name.hinted-text{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: 3px;
      color: var(--warn);
      font-size: 13px;
    }
    .btn.hint-active{
      border-color: rgba(245,158,11,.55);
      background: rgba(245,158,11,.18);
      color: var(--warn);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="crown" aria-hidden="true">üëë</div>
        <div class="title">
          <h1>Quiz ‚Äî Monarques (Angleterre ‚Üí Royaume-Uni)</h1>
          <p>Par dynastie</p>
        </div>
      </div>

      <div class="meta">
        <button class="btn" id="btnHome">üè† Accueil</button>
        <div class="pill">‚è±Ô∏è Temps : <strong id="timer">00:00</strong></div>
        <div class="pill">üéØ Score : <strong id="score">0</strong>/<strong id="total">0</strong></div>
        <button class="btn" id="btnHint">üí° Indice</button>
        <button class="btn" id="btnPause">‚è∏Ô∏è Pause</button>
        <button class="btn primary" id="btnReset">üîÑ Recommencer</button>
        <button class="btn" id="btnGiveUp">üè≥Ô∏è Abandonner</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="count" id="count">0 / 0</div>
          <div class="bar"><div class="fill" id="fill"></div></div>
        </div>
        <div class="hint" style="padding:0; max-width:660px;">
          ‚úÖ <strong>Ordre libre</strong> ‚Äî tape un nom, surnom, alias ou variante fran√ßaise.<br>
          <span style="display:inline-block; opacity:.9">
            Chiffres arabes/romains + ordinaux accept√©s (ex : <em>Henry 8</em>, <em>Henry 8th</em>, <em>Henri VIII</em>).<br>
            Pour les pr√©noms partag√©s, pr√©cise le num√©ro (ex : <em>Henry IV</em> et pas <em>Henry</em> seul).<br>
            Surnoms : <em>Canute, Ironside, Lionheart, Bloody Mary, Lady Jane Grey, Virgin Queen‚Ä¶</em>
          </span>
        </div>
      </div>

      <div class="inputArea">
        <div class="inputRow">
          <input id="input" type="text" placeholder="Tape un roi ou une reine (Angleterre / GB / UK)‚Ä¶" autocomplete="off" />
          <button class="btn" id="btnSubmit">‚úÖ Valider</button>
        </div>
      </div>
      <div id="toast" class="toast"></div>

      <div class="gridWrap">
        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>

<script>
  // --------- Utils ----------
  function normalize(str) {
    return (str || "")
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/≈ì/g,"oe")
      .replace(/√¶/g,"ae")
      .replace(/[^a-z0-9]/g, "");
  }

  // Roman helpers (pour accepter XIV / 14, etc.)
  const romanMap = { I:1, V:5, X:10, L:50, C:100, D:500, M:1000 };
  function romanToInt(roman){
    if(!roman) return null;
    roman = roman.toUpperCase().replace(/[^IVXLCDM]/g,"");
    if(!roman) return null;
    let total = 0, prev = 0;
    for(let i=roman.length-1;i>=0;i--){
      const v = romanMap[roman[i]] || 0;
      if(v < prev) total -= v; else total += v;
      prev = v;
    }
    return total || null;
  }
  function intToRoman(num){
    if(!num || num<=0 || num>3999) return "";
    const vals = [
      [1000,"M"],[900,"CM"],[500,"D"],[400,"CD"],
      [100,"C"],[90,"XC"],[50,"L"],[40,"XL"],
      [10,"X"],[9,"IX"],[5,"V"],[4,"IV"],[1,"I"]
    ];
    let n=num, out="";
    for(const [v,s] of vals){
      while(n>=v){ out+=s; n-=v; }
    }
    return out;
  }

  // Ordinal helper : "4th"‚Üí4, "1st"‚Üí1, "2nd"‚Üí2, "3rd"‚Üí3
  function ordinalToInt(str){
    const m = str.match(/^(\d+)(?:st|nd|rd|th)$/i);
    return m ? parseInt(m[1],10) : null;
  }

  // --------- Data ----------
  // Angleterre (Kingdom of England) ‚Üí Grande-Bretagne (1707) ‚Üí Royaume-Uni (1801)
  const dynasties = [
    {
      id:"wessex",
      name:"Maison de Wessex (Rois des Anglais)",
      range:"(927‚Äì1066)",
      kings:[
        { id:"wes-0927-athelstan", label:"927", king:"√Üthelstan", reign:"927‚Äì939", fact:"üß© Souvent consid√©r√© comme le 1er ‚Äúroi des Anglais‚Äù au sens plein." },
        { id:"wes-0939-edmund1",   label:"939", king:"Edmund I", reign:"939‚Äì946", fact:"‚öîÔ∏è R√®gne court et agit√© : l‚Äôunification se joue encore sur le terrain." },
        { id:"wes-0946-eadred",    label:"946", king:"Eadred", reign:"946‚Äì955", fact:"üè∞ Il consolide l‚Äôautorit√© face aux r√©sistances (notamment au Nord)." },
        { id:"wes-0955-eadwig",    label:"955", king:"Eadwig", reign:"955‚Äì959", fact:"‚è±Ô∏è R√®gne tr√®s court : l‚ÄôAngleterre n‚Äôaime pas trop les transitions." },
        { id:"wes-0959-edgar",     label:"959", king:"Edgar the Peaceful", reign:"959‚Äì975", fact:"üïäÔ∏è Surnomm√© ‚Äúthe Peaceful‚Äù : rare p√©riode de stabilit√© relative." },
        { id:"wes-0975-edwardmartyr", label:"975", king:"Edward the Martyr", reign:"975‚Äì978", fact:"üïØÔ∏è Mort violente : une succession qui tourne au drame." },
        { id:"wes-0978-aethelred2", label:"978", king:"√Üthelred II (the Unready)", reign:"978‚Äì1013 & 1014‚Äì1016", fact:"üõ°Ô∏è ‚ÄúUnready‚Äù = ‚Äúmal conseill√©‚Äù : l‚Äô√®re des raids vikings bat son plein." },
        { id:"wes-1013-sweyn",     label:"1013", king:"Sweyn Forkbeard", reign:"1013‚Äì1014", fact:"ü™ì Roi danois : un √©pisode √©clair‚Ä¶ mais d√©cisif." },
        { id:"wes-1016-edmund2",   label:"1016", king:"Edmund II (Ironside)", reign:"1016", fact:"ü¶æ ‚ÄúIronside‚Äù : surnom de dur √† cuire, r√®gne express." },
        { id:"wes-1016-cnut",      label:"1016", king:"Cnut", reign:"1016‚Äì1035", fact:"üåä La l√©gende du roi face aux vagues : symbole des limites du pouvoir." },
        { id:"wes-1035-haroldharefoot", label:"1035", king:"Harold I (Harefoot)", reign:"1035‚Äì1040", fact:"üèÉ ‚ÄúHarefoot‚Äù : un surnom qui claque pour un r√®gne de transition." },
        { id:"wes-1040-harthacnut", label:"1040", king:"Harthacnut", reign:"1040‚Äì1042", fact:"üçª Sa mort soudaine lors d‚Äôune f√™te est rest√©e c√©l√®bre." },
        { id:"wes-1042-edwardconfessor", label:"1042", king:"Edward the Confessor", reign:"1042‚Äì1066", fact:"‚õ™ Il est associ√© √† Westminster et √† une aura ‚Äúsaintet√©‚Äù." },
        { id:"wes-1066-harold2",   label:"1066", king:"Harold II", reign:"1066", fact:"üèπ 1066 : ann√©e mythique ‚Äî tout bascule en quelques mois." },
      ]
    },
    {
      id:"norman",
      name:"Normands",
      range:"(1066‚Äì1154)",
      kings:[
        { id:"nor-1066-william1", label:"1066", king:"William I (the Conqueror)", reign:"1066‚Äì1087", fact:"üó∫Ô∏è Domesday Book : un inventaire √©norme (et redoutable) du royaume." },
        { id:"nor-1087-william2", label:"1087", king:"William II (Rufus)", reign:"1087‚Äì1100", fact:"üèπ Mort en chasse : une fin myst√©rieuse qui fait parler." },
        { id:"nor-1100-henry1",   label:"1100", king:"Henry I", reign:"1100‚Äì1135", fact:"üìú Il renforce l‚Äôadministration : l‚Äô√âtat se structure." },
        { id:"nor-1135-stephen",  label:"1135", king:"Stephen", reign:"1135‚Äì1154", fact:"üåÄ ‚ÄúThe Anarchy‚Äù : p√©riode de guerre civile et d‚Äôinstabilit√©." },
      ]
    },
    {
      id:"plantagenet",
      name:"Plantagen√™ts / Angevins",
      range:"(1154‚Äì1399)",
      kings:[
        { id:"pla-1154-henry2",  label:"1154", king:"Henry II", reign:"1154‚Äì1189", fact:"‚öñÔ∏è Conflit c√©l√®bre avec Thomas Becket : pouvoir vs √âglise." },
        { id:"pla-1189-richard1",label:"1189", king:"Richard I (the Lionheart)", reign:"1189‚Äì1199", fact:"ü¶Å Ic√¥ne des croisades : plus souvent sur les routes qu‚Äô√† Londres." },
        { id:"pla-1199-john",    label:"1199", king:"John", reign:"1199‚Äì1216", fact:"üìú 1215 : Magna Carta ‚Äî un texte-cl√© sur les limites du pouvoir." },
        { id:"pla-1216-henry3",  label:"1216", king:"Henry III", reign:"1216‚Äì1272", fact:"üè∞ Westminster prend forme : gros chantier symbolique." },
        { id:"pla-1272-edward1", label:"1272", king:"Edward I (Longshanks)", reign:"1272‚Äì1307", fact:"üß± Surnomm√© ‚ÄúLongshanks‚Äù : grand format et gros temp√©rament." },
        { id:"pla-1307-edward2", label:"1307", king:"Edward II", reign:"1307‚Äì1327", fact:"‚ôüÔ∏è R√®gne tr√®s contest√© : les favoris et la politique font des √©tincelles." },
        { id:"pla-1327-edward3", label:"1327", king:"Edward III", reign:"1327‚Äì1377", fact:"üõ°Ô∏è D√©but de la guerre de Cent Ans c√¥t√© anglais : l‚ÄôEurope s‚Äôembrase." },
        { id:"pla-1377-richard2",label:"1377", king:"Richard II", reign:"1377‚Äì1399", fact:"üé≠ D√©pos√© : la couronne change de mains (et de maison)." },
      ]
    },
    {
      id:"lancaster",
      name:"Lancastre",
      range:"(1399‚Äì1461)",
      kings:[
        { id:"lan-1399-henry4", label:"1399", king:"Henry IV", reign:"1399‚Äì1413", fact:"üß® Premier Lancastre : une nouvelle branche s‚Äôimpose." },
        { id:"lan-1413-henry5", label:"1413", king:"Henry V", reign:"1413‚Äì1422", fact:"üèπ Azincourt (1415) : bataille devenue l√©gende." },
        { id:"lan-1422-henry6", label:"1422", king:"Henry VI", reign:"1422‚Äì1461 & 1470‚Äì1471", fact:"üåπ Guerre des Deux-Roses : l‚ÄôAngleterre se fracture." },
      ]
    },
    {
      id:"york",
      name:"York",
      range:"(1461‚Äì1485)",
      kings:[
        { id:"yor-1461-edward4", label:"1461", king:"Edward IV", reign:"1461‚Äì1470 & 1471‚Äì1483", fact:"‚öîÔ∏è Un r√®gne de reconqu√™te : aller-retour sur le tr√¥ne." },
        { id:"yor-1483-edward5", label:"1483", king:"Edward V", reign:"1483", fact:"üïØÔ∏è L‚Äôun des ‚ÄúPrinces in the Tower‚Äù : myst√®re historique majeur." },
        { id:"yor-1483-richard3", label:"1483", king:"Richard III", reign:"1483‚Äì1485", fact:"üè¥ Fin √† Bosworth : un tournant qui ouvre l‚Äô√®re Tudor." },
      ]
    },
    {
      id:"tudor",
      name:"Tudor",
      range:"(1485‚Äì1603)",
      kings:[
        { id:"tud-1485-henry7",  label:"1485", king:"Henry VII", reign:"1485‚Äì1509", fact:"üí∞ Il stabilise les finances : apr√®s la temp√™te, l‚Äôaddition." },
        { id:"tud-1509-henry8",  label:"1509", king:"Henry VIII", reign:"1509‚Äì1547", fact:"‚õ™ Rupture avec Rome : l‚ÄôAngleterre change d‚Äô√®re religieuse." },
        { id:"tud-1547-edward6", label:"1547", king:"Edward VI", reign:"1547‚Äì1553", fact:"üë¶ Roi tr√®s jeune : les r√©gents gouvernent en coulisses." },
        { id:"tud-1553-jane",    label:"1553", king:"Lady Jane Grey", reign:"1553", fact:"‚è≥ ‚ÄúNine Days‚Äô Queen‚Äù : un r√®gne flash (mais inoubliable)." },
        { id:"tud-1553-mary1",   label:"1553", king:"Mary I", reign:"1553‚Äì1558", fact:"üî• Surnomm√©e ‚ÄúBloody Mary‚Äù : p√©riode de r√©pression religieuse." },
        { id:"tud-1558-elizabeth1", label:"1558", king:"Elizabeth I", reign:"1558‚Äì1603", fact:"üé≠ Shakespeare, expansion maritime : l‚Äô‚ÄúElizabethan era‚Äù en mode XXL." },
      ]
    },
    {
      id:"stuart",
      name:"Stuart",
      range:"(1603‚Äì1714)",
      kings:[
        { id:"stu-1603-james1",  label:"1603", king:"James I", reign:"1603‚Äì1625", fact:"üìñ La King James Bible : √©norme impact culturel et religieux." },
        { id:"stu-1625-charles1",label:"1625", king:"Charles I", reign:"1625‚Äì1649", fact:"‚öñÔ∏è Proc√®s et ex√©cution : √©v√©nement choc dans l‚Äôhistoire anglaise." },
        { id:"stu-1660-charles2",label:"1660", king:"Charles II", reign:"1660‚Äì1685", fact:"üèôÔ∏è Restauration : Londres se rel√®ve apr√®s peste et grand incendie." },
        { id:"stu-1685-james2",  label:"1685", king:"James II", reign:"1685‚Äì1688", fact:"üß® Renvers√© lors de la ‚ÄúGlorious Revolution‚Äù." },
        { id:"stu-1689-mary2",   label:"1689", king:"Mary II", reign:"1689‚Äì1694", fact:"üëë R√®gne conjoint : une co-souverainet√© rare et marquante." },
        { id:"stu-1689-william3",label:"1689", king:"William III", reign:"1689‚Äì1702", fact:"üìú Bill of Rights (1689) : base du parlementarisme moderne." },
        { id:"stu-1702-anne",    label:"1702", king:"Anne", reign:"1702‚Äì1714 (GB) ‚Äî 1707 : Union", fact:"ü§ù 1707 : Acte d‚ÄôUnion ‚Äî naissance du Royaume de Grande-Bretagne." },
      ]
    },

    /* ‚úÖ AJOUT : jusqu‚Äô√† aujourd‚Äôhui */
    {
      id:"hanover",
      name:"Hanovre",
      range:"(1714‚Äì1901)",
      kings:[
        { id:"han-1714-george1",  label:"1714", king:"George I",  reign:"1714‚Äì1727", fact:"üá©üá™ Premier Hanovrien : une dynastie venue d‚ÄôAllemagne." },
        { id:"han-1727-george2",  label:"1727", king:"George II", reign:"1727‚Äì1760", fact:"üéº Il soutient la vie culturelle (Handel, etc.)." },
        { id:"han-1760-george3",  label:"1760", king:"George III",reign:"1760‚Äì1820", fact:"üó∫Ô∏è Son r√®gne couvre la R√©volution am√©ricaine et l‚Äô√®re napol√©onienne." },
        { id:"han-1820-george4",  label:"1820", king:"George IV", reign:"1820‚Äì1830", fact:"üèõÔ∏è R√©gent avant d‚Äô√™tre roi : style ‚ÄúRegency‚Äù + grand go√ªt pour l‚Äôarchitecture." },
        { id:"han-1830-william4", label:"1830", king:"William IV",reign:"1830‚Äì1837", fact:"üó≥Ô∏è Son r√®gne voit une grande r√©forme √©lectorale (1832)." },
        { id:"han-1837-victoria", label:"1837", king:"Victoria",  reign:"1837‚Äì1901", fact:"üåç ‚ÄúVictorian era‚Äù : industrialisation + empire √† son apog√©e." },
      ]
    },
    {
      id:"saxe",
      name:"Saxe-Cobourg-Gotha",
      range:"(1901‚Äì1917)",
      kings:[
        { id:"sax-1901-edward7", label:"1901", king:"Edward VII", reign:"1901‚Äì1910", fact:"ü§ù ‚ÄúEdwardian era‚Äù : une parenth√®se avant la Grande Guerre." },
      ]
    },
    {
      id:"windsor",
      name:"Windsor",
      range:"(1910‚Äìaujourd‚Äôhui)",
      kings:[
        { id:"win-1910-george5",  label:"1910", king:"George V",   reign:"1910‚Äì1936", fact:"üè∑Ô∏è 1917 : la maison prend le nom ‚ÄúWindsor‚Äù pendant la Premi√®re Guerre mondiale." },
        { id:"win-1936-edward8",  label:"1936", king:"Edward VIII",reign:"1936", fact:"üíç Abdique pour √©pouser Wallis Simpson : crise constitutionnelle." },
        { id:"win-1936-george6",  label:"1936", king:"George VI",  reign:"1936‚Äì1952", fact:"üéôÔ∏è Seconde Guerre mondiale : symbole de r√©silience nationale." },
        { id:"win-1952-elizabeth2", label:"1952", king:"Elizabeth II", reign:"1952‚Äì2022", fact:"‚è≥ R√®gne record au Royaume-Uni : 70 ans sur le tr√¥ne." },
        { id:"win-2022-charles3", label:"2022", king:"Charles III", reign:"2022‚Äì‚Ä¶", fact:"‚ôªÔ∏è Longtemps prince de Galles : tr√®s engag√© sur l‚Äôenvironnement." },
      ]
    }
  ];

  // Flatten
  const kings = [];
  for (const d of dynasties) for (const k of d.kings) kings.push({ ...k, dynastyId:d.id });
  const TOTAL = kings.length;

  // Index
  const byId = new Map();
  const byKey = new Map();         // key -> id (canonical)
  const ambiguousKeys = new Set(); // cl√©s pointant vers plusieurs monarques
  const allKeys = new Set();

  // Suivi des pr√©noms partag√©s (Henry, Edward, George...)
  const firstNameCount = new Map(); // pr√©nom normalis√© -> Set d'ids

  function addKey(key, id){
    if(!key) return;
    const k = normalize(key);
    if(!k) return;
    allKeys.add(k);
    if(!byKey.has(k)){
      byKey.set(k, id);
    } else if(byKey.get(k) !== id){
      ambiguousKeys.add(k);
    }
  }

  // Ajoute toutes les variantes num√©riques / romaines / ordinales pour "Base N"
  function addNumVariants(base, asInt, id){
    if(!asInt) return;
    const roman = intToRoman(asInt);
    const ordSuffix = asInt===1?"st":asInt===2?"nd":asInt===3?"rd":"th";
    addKey(base+" "+roman, id);
    addKey(base+" "+asInt, id);
    addKey(base+asInt, id);
    addKey(base+roman, id);
    addKey(base+" "+asInt+ordSuffix, id);
    addKey(base+asInt+ordSuffix, id);
    if(asInt===1){
      addKey(base+" 1er", id);
      addKey(base+" ier", id);
      addKey(base+" premier", id);
      addKey(base+" first", id);
    }
  }

  for (const k of kings) {
    byId.set(k.id, k);

    // Canonical
    addKey(k.king, k.id);

    // Variantes sans parenth√®ses / surnoms
    const paren = k.king.match(/^(.+?)\s*\((.+)\)\s*$/);
    if (paren) {
      addKey(paren[1].trim(), k.id);
      addKey(paren[2].trim(), k.id);
    }

    // Variantes chiffres / romains / ordinaux
    const m = k.king.match(/^(.*?)(\s+)([IVXLCDM]+|\d+)\s*$/i);
    if (m) {
      const base = m[1].trim();
      const rawNum = m[3].trim();
      const asInt = /^\d+$/.test(rawNum) ? parseInt(rawNum,10) : romanToInt(rawNum);
      addNumVariants(base, asInt, k.id);

      // Pr√©nom seul : tracker les collisions
      const normBase = normalize(base);
      if(!firstNameCount.has(normBase)) firstNameCount.set(normBase, new Set());
      firstNameCount.get(normBase).add(k.id);
      addKey(base, k.id);
    }

    // Variantes fr√©quentes
    addKey(k.king.replace(/\bthe\b/gi,"").trim(), k.id);
  }

  // Marquer tous les pr√©noms partag√©s comme ambigus
  for(const [fn, ids] of firstNameCount){
    if(ids.size > 1) ambiguousKeys.add(fn);
  }

  // Map pr√©nom -> liste des rois (pour message d'aide)
  const ambiguousHelp = new Map();
  for(const [fn, ids] of firstNameCount){
    if(ids.size > 1){
      const list = [...ids].map(id => byId.get(id)).filter(Boolean);
      ambiguousHelp.set(fn, list);
    }
  }

  // --------- Distance de Levenshtein (suggestion "vouliez-vous dire ?") ----------
  function levenshtein(a, b){
    const m=a.length, n=b.length;
    if(m===0) return n; if(n===0) return m;
    const dp=Array.from({length:m+1},(_,i)=>Array.from({length:n+1},(_,j)=>i===0?j:j===0?i:0));
    for(let i=1;i<=m;i++) for(let j=1;j<=n;j++)
      dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j-1],dp[i-1][j],dp[i][j-1]);
    return dp[m][n];
  }

  function findClosestKey(norm){
    if(norm.length < 3) return null;
    let best=null, bestDist=Infinity;
    for(const [k, id] of byKey){
      if(ambiguousKeys.has(k)) continue;
      const d = levenshtein(norm, k);
      const threshold = Math.max(2, Math.floor(norm.length * 0.28));
      if(d < bestDist && d <= threshold){ bestDist=d; best={id, dist:d}; }
    }
    return best;
  }

  // Alias directs [cl√© normalis√©e -> id exact du monarque]
  const directAliases = [
    // Anglo-Saxons
    ["athelstan",            "wes-0927-athelstan"],
    ["aethelstan",           "wes-0927-athelstan"],
    ["ethelstan",            "wes-0927-athelstan"],
    ["aethelred",            "wes-0978-aethelred2"],
    ["ethelred",             "wes-0978-aethelred2"],
    ["aethelredtheunready",  "wes-0978-aethelred2"],
    ["ethelredtheunready",   "wes-0978-aethelred2"],
    ["unready",              "wes-0978-aethelred2"],
    ["theunready",           "wes-0978-aethelred2"],
    ["canute",               "wes-1016-cnut"],
    ["knutr",                "wes-1016-cnut"],
    ["kingcanute",           "wes-1016-cnut"],
    // Correction bug : id r√©el de Harold I Harefoot
    ["haroldharefoot",       "wes-1035-haroldharefoot"],
    ["harold1",              "wes-1035-haroldharefoot"],
    ["haroldi",              "wes-1035-haroldharefoot"],
    ["sweynforkbeard",       "wes-1013-sweyn"],
    ["sveinforkbeard",       "wes-1013-sweyn"],
    ["ironside",             "wes-1016-edmund2"],
    ["edmundironside",       "wes-1016-edmund2"],
    ["edwardtheconfessor",   "wes-1042-edwardconfessor"],
    ["edwardconfessor",      "wes-1042-edwardconfessor"],
    ["haroldgodwinson",      "wes-1066-harold2"],
    // Normands
    ["williamconqueror",     "nor-1066-william1"],
    ["williamtheconqueror",  "nor-1066-william1"],
    ["rufus",                "nor-1087-william2"],
    ["williamrufus",         "nor-1087-william2"],
    // Plantagen√™ts
    ["lionheart",            "pla-1189-richard1"],
    ["richardlionheart",     "pla-1189-richard1"],
    ["richardcoeurdelion",   "pla-1189-richard1"],
    ["coeurdelion",          "pla-1189-richard1"],
    ["johnlackland",         "pla-1199-john"],
    ["kingjohn",             "pla-1199-john"],
    ["longshanks",           "pla-1272-edward1"],
    ["edwardlongshanks",     "pla-1272-edward1"],
    ["henrybolingbroke",     "lan-1399-henry4"],
    ["bolingbroke",          "lan-1399-henry4"],
    // Tudor
    ["bloodymary",           "tud-1553-mary1"],
    ["virginqueen",          "tud-1558-elizabeth1"],
    ["goodqueenbess",        "tud-1558-elizabeth1"],
    ["queenbess",            "tud-1558-elizabeth1"],
    ["elizabethvirginqueen", "tud-1558-elizabeth1"],
    ["ninedaysqueen",        "tud-1553-jane"],
    ["ladyjane",             "tud-1553-jane"],
    ["ladyjanegrey",         "tud-1553-jane"],
    ["janegrey",             "tud-1553-jane"],
    // Stuart
    ["jamesbible",           "stu-1603-james1"],
    ["kingsjamesbible",      "stu-1603-james1"],
    ["gloriousrevolution",   "stu-1689-william3"],
    ["billofrights",         "stu-1689-william3"],
    ["williamorange",        "stu-1689-william3"],
    ["williamoforange",      "stu-1689-william3"],
    ["queenanne",            "stu-1702-anne"],
    // Hanovre
    ["victoria",             "han-1837-victoria"],
    ["queenvictoria",        "han-1837-victoria"],
    // Windsor
    ["queenelizabeth",       "win-1952-elizabeth2"],
    ["queenelizabeth2",      "win-1952-elizabeth2"],
    ["queenelizabethii",     "win-1952-elizabeth2"],
    ["elizabeth2",           "win-1952-elizabeth2"],
    ["elizabethii",          "win-1952-elizabeth2"],
    ["edward8",              "win-1936-edward8"],
    ["edwardviii",           "win-1936-edward8"],
    ["george5",              "win-1910-george5"],
    ["georgev",              "win-1910-george5"],
    ["george6",              "win-1936-george6"],
    ["georgevi",             "win-1936-george6"],
    ["charles3",             "win-2022-charles3"],
    ["charlesiii",           "win-2022-charles3"],
    ["kingcharles",          "win-2022-charles3"],
    ["kingcharles3",         "win-2022-charles3"],
    ["kingcharlesiii",       "win-2022-charles3"],
    // Alias fran√ßais ‚Äî Henri -> Henry
    ["henri1","nor-1100-henry1"],   ["henrii","nor-1100-henry1"],
    ["henri2","pla-1154-henry2"],   ["henriii","pla-1154-henry2"],
    ["henri3","pla-1216-henry3"],   ["henriiii","pla-1216-henry3"],
    ["henri4","lan-1399-henry4"],   ["henriiv","lan-1399-henry4"],
    ["henri5","lan-1413-henry5"],   ["henriv","lan-1413-henry5"],
    ["henri6","lan-1422-henry6"],   ["henrivi","lan-1422-henry6"],
    ["henri7","tud-1485-henry7"],   ["henrivii","tud-1485-henry7"],
    ["henri8","tud-1509-henry8"],   ["henriviii","tud-1509-henry8"],
    // Edouard -> Edward
    ["edouard1","pla-1272-edward1"],  ["edouardier","pla-1272-edward1"],
    ["edouard2","pla-1307-edward2"],  ["edouardii","pla-1307-edward2"],
    ["edouard3","pla-1327-edward3"],  ["edouardiii","pla-1327-edward3"],
    ["edouard4","yor-1461-edward4"],  ["edouardiv","yor-1461-edward4"],
    ["edouard5","yor-1483-edward5"],  ["edouardv","yor-1483-edward5"],
    ["edouard6","tud-1547-edward6"],  ["edouardvi","tud-1547-edward6"],
    ["edouard7","sax-1901-edward7"],  ["edouardvii","sax-1901-edward7"],
    ["edouard8","win-1936-edward8"],  ["edouardviii","win-1936-edward8"],
    // Autres pr√©noms fran√ßais
    ["richard1","pla-1189-richard1"], ["richard2","pla-1377-richard2"],
    ["guillaume1","nor-1066-william1"],["guillaume2","nor-1087-william2"],
    ["guillaume3","stu-1689-william3"],
    ["guillaumeconquerant","nor-1066-william1"],
    ["georges1","han-1714-george1"],  ["georges2","han-1727-george2"],
    ["georges3","han-1760-george3"],  ["georges4","han-1820-george4"],
    ["georges5","win-1910-george5"],  ["georges6","win-1936-george6"],
    ["charles1","stu-1625-charles1"], ["charles2","stu-1660-charles2"],
    ["marie1","tud-1553-mary1"],      ["marie2","stu-1689-mary2"],
    ["marietutor","tud-1553-mary1"],
    ["elisabeth1","tud-1558-elizabeth1"], ["elisabethi","tud-1558-elizabeth1"],
    ["elisabeth2","win-1952-elizabeth2"], ["elisabethii","win-1952-elizabeth2"],
    ["jacques1","stu-1603-james1"],   ["jacquesi","stu-1603-james1"],
    ["jacques2","stu-1685-james2"],   ["jacquesii","stu-1685-james2"],
  ];

  for(const [alias, id] of directAliases){
    const k = normalize(alias);
    if(!k) continue;
    allKeys.add(k);
    if(!byKey.has(k)) byKey.set(k, id);
  }

  // Personnages souvent tap√©s mais ABSENTS du quiz
  const notInQuiz = new Map([
    ["empressmatilda",  "Empress Matilda n'est pas list√©e : elle ne fut jamais officiellement couronn√©e reine d'Angleterre."],
    ["matilda",         "Empress Matilda n'est pas list√©e : elle ne fut jamais officiellement couronn√©e reine d'Angleterre."],
    ["anneboleyn",      "Anne Boleyn √©tait reine consort, pas reine r√©gnante. Ce quiz liste uniquement les monarques r√©gnants."],
    ["catherinearagon", "Catherine d'Aragon √©tait reine consort. Ce quiz liste uniquement les monarques r√©gnants."],
    ["maryqueenofscots","Marie Reine d'√âcosse r√©gnait en √âcosse, pas en Angleterre."],
    ["cromwell",        "Oliver Cromwell √©tait Lord Protecteur, pas roi. Non list√© dans ce quiz."],
    ["olivercromwell",  "Oliver Cromwell √©tait Lord Protecteur, pas roi. Non list√© dans ce quiz."],
  ]);

  // --------- State ----------
  const foundIds = new Set();
  let timerInterval = null;
  let startTs = null;
  let elapsedMs = 0;
  let isPaused = false;
  let isFinished = false;
  let isGivenUp = false;

  // --------- Timer ----------
  const timerEl = document.getElementById("timer");
  const btnPause = document.getElementById("btnPause");

  function fmtTimeFromMs(ms) {
    const seconds = Math.floor(ms / 1000);
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function renderTimer() {
    timerEl.textContent = fmtTimeFromMs(elapsedMs + (startTs ? (Date.now() - startTs) : 0));
  }
  function stopTimerIntervalOnly() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
  }
  function startTimerIfNeeded() {
    if (isFinished || isPaused || isGivenUp) return;
    if (timerInterval) return;
    if (!startTs) startTs = Date.now();
    timerInterval = setInterval(renderTimer, 250);
  }
  function stopTimer() {
    if (startTs) { elapsedMs += (Date.now() - startTs); startTs = null; }
    stopTimerIntervalOnly();
    renderTimer();
  }
  function resetTimer() {
    stopTimerIntervalOnly();
    startTs = null;
    elapsedMs = 0;
    isPaused = false;
    isFinished = false;
    isGivenUp = false;
    btnPause.disabled = false;
    btnPause.textContent = "‚è∏Ô∏è Pause";
    timerEl.textContent = "00:00";
  }
  function pauseTimer() {
    if (isFinished || isGivenUp || isPaused) return;
    if (startTs) { elapsedMs += (Date.now() - startTs); startTs = null; }
    stopTimerIntervalOnly();
    isPaused = true;
    btnPause.textContent = "‚ñ∂Ô∏è Reprendre";
    setToast("warn", "‚è∏Ô∏è Timer en pause.");
  }
  function resumeTimer() {
    if (isFinished || isGivenUp || !isPaused) return;
    isPaused = false;
    startTs = Date.now();
    btnPause.textContent = "‚è∏Ô∏è Pause";
    setToast("", "");
    startTimerIfNeeded();
  }
  function togglePause() {
    if (isFinished || isGivenUp) return;
    if (isPaused) resumeTimer(); else pauseTimer();
  }

  // --------- UI ----------
  const input = document.getElementById("input");
  const toast = document.getElementById("toast");
  const countEl = document.getElementById("count");
  const fillEl = document.getElementById("fill");
  const gridEl = document.getElementById("grid");
  const scoreEl = document.getElementById("score");
  const totalEl = document.getElementById("total");
  const btnGiveUp = document.getElementById("btnGiveUp");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnHint   = document.getElementById("btnHint");

  function setToast(type, msg) {
    toast.className = "toast " + (type || "");
    toast.textContent = msg || "";
  }

  function updateStats() {
    const n = foundIds.size;
    countEl.textContent = `${n} / ${TOTAL}`;
    scoreEl.textContent = n;
    totalEl.textContent = TOTAL;
    fillEl.style.width = `${(n / TOTAL) * 100}%`;
    // Mettre √† jour les compteurs par dynastie
    for(const d of dynasties){
      const el = document.getElementById(`dyncount-${d.id}`);
      if(!el) continue;
      const found = d.kings.filter(k => foundIds.has(k.id)).length;
      const total = d.kings.length;
      el.textContent = `${found}/${total}`;
      el.style.color = found === total ? "var(--good)" : found > 0 ? "var(--warn)" : "";
    }
  }

  function buildGrid() {
    gridEl.innerHTML = "";

    for (const d of dynasties) {
      const g = document.createElement("div");
      g.className = "group";
      g.innerHTML = `
        <div class="gName">üëë ${d.name}</div>
        <div style="display:flex;align-items:center;gap:10px;flex-shrink:0">
          <span class="gRange">${d.range}</span>
          <span class="gCount" id="dyncount-${d.id}">0/${d.kings.length}</span>
        </div>
      `;
      gridEl.appendChild(g);

      for (const k of d.kings) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.id = `cell-${k.id}`;
        cell.innerHTML = `
          <div class="left">
            <div class="num">${k.label}</div>
            <div style="min-width:0">
              <div class="name masked" id="name-${k.id}">??????</div>
              <div class="info" id="info-${k.id}" style="display:none;"></div>
            </div>
          </div>
          <div class="status" id="status-${k.id}">‚Äî</div>
        `;
        gridEl.appendChild(cell);
      }
    }
  }

  function revealId(id, mode /* "found" | "revealed" */) {
    const k = byId.get(id);
    if (!k) return;

    const cell = document.getElementById(`cell-${k.id}`);
    const nameEl = document.getElementById(`name-${k.id}`);
    const infoEl = document.getElementById(`info-${k.id}`);
    const statusEl = document.getElementById(`status-${k.id}`);

    cell.classList.add(mode === "found" ? "found" : "revealed");
    cell.classList.remove(mode === "found" ? "revealed" : "found");

    nameEl.textContent = `${k.king} ‚Äî ${k.reign}`;
    nameEl.classList.remove("masked");

    infoEl.style.display = "block";
    infoEl.textContent = k.fact ? `üí° ${k.fact}` : "üí° ‚Äî";

    statusEl.textContent = mode === "found" ? "‚úÖ" : "‚ùå";
  }

  function revealMissingSolutions() {
    for (const k of kings) {
      if (foundIds.has(k.id)) continue;
      revealId(k.id, "revealed");
    }
  }

  function giveUp() {
    if (isFinished || isGivenUp) return;

    isGivenUp = true;
    stopTimer();

    btnPause.disabled = true;
    btnPause.textContent = "‚èπÔ∏è Stop";
    btnHint.disabled = true;
    input.disabled = true;
    btnSubmit.disabled = true;

    revealMissingSolutions();

    const n = foundIds.size;
    setToast("bad", `üè≥Ô∏è Abandon : ${n}/${TOTAL} trouv√©s en ${timerEl.textContent}. Solutions + faits affich√©s en rouge.`);
  }

  function finish() {
    isFinished = true;
    stopTimer();

    btnPause.disabled = true;
    btnPause.textContent = "üèÅ Termin√©";
    btnGiveUp.disabled = true;
    btnHint.disabled = true;
    input.disabled = true;
    btnSubmit.disabled = true;

    setToast("good", `üèÜ ${TOTAL}/${TOTAL} ! Liste compl√©t√©e en ${timerEl.textContent} !`);
  }

  function tryFindKing(raw){
    const norm = normalize(raw);
    if(!norm) return null;
    if(byKey.has(norm) && !ambiguousKeys.has(norm)) return byKey.get(norm);
    if(byKey.has(norm) && ambiguousKeys.has(norm)) return "__ambiguous__:"+norm;
    return null;
  }

  function buildAmbiguousMsg(normBase){
    const list = ambiguousHelp.get(normBase) || [];
    const examples = list.map(k => {
      const m2 = k.king.match(/^(.*?)(\s+)([IVXLCDM]+|\d+)\s*$/i);
      if(m2) return normalize(k.king);
      return normalize(k.king);
    }).slice(0,8).join(", ");
    const hint = list.map(k => {
      const m2 = k.king.match(/^(.*?)(\s+)([IVXLCDM]+|\d+)\s*$/i);
      if(m2) return k.king;
      return k.king;
    }).join(" / ");
    return `‚ö†Ô∏è Plusieurs monarques s'appellent ainsi. Pr√©cise le num√©ro : ${hint}`;
  }

  function validate(raw) {
    const norm = normalize(raw);

    // Personnage connu mais absent du quiz
    if(notInQuiz.has(norm)){
      setToast("warn", "‚ÑπÔ∏è "+notInQuiz.get(norm));
      return { ok:false };
    }

    const result = tryFindKing(raw);

    // Ambigu : pr√©nom partag√© sans num√©ro
    if(result && result.startsWith("__ambiguous__:")){
      const normBase = result.slice(14);
      setToast("warn", buildAmbiguousMsg(normBase));
      return { ok:false };
    }

    const id = result;
    if (!id) {
      // Tentative de suggestion par proximit√© (Levenshtein)
      const closest = findClosestKey(norm);
      if(closest){
        const k2 = byId.get(closest.id);
        if(k2) {
          setToast("warn", `‚ùì Pas reconnu. Vouliez-vous dire : ${k2.king} ?`);
          return { ok:false };
        }
      }
      setToast("bad", "‚ùå Monarque non reconnu. V√©rifie l'orthographe ou ajoute le num√©ro (ex : Henry VIII, Edward 3).");
      return { ok:false };
    }
    if (foundIds.has(id)) {
      const k2 = byId.get(id);
      setToast("warn", `‚ö†Ô∏è D√©j√† trouv√© : ${k2 ? k2.king : id}`);
      return { ok:false };
    }

    startTimerIfNeeded();

    foundIds.add(id);
    revealId(id, "found");
    // Nettoyer les classes d'indice sur la case trouv√©e
    const hintCell = document.getElementById(`cell-${id}`);
    const hintName = document.getElementById(`name-${id}`);
    if(hintCell) hintCell.classList.remove("hinted");
    if(hintName) hintName.classList.remove("hinted-text");
    updateStats();

    const k = byId.get(id);
    setToast("good", `‚úÖ ${k.king} (${k.reign}) ‚Äî üí° ${k.fact}`);

    const cell = document.getElementById(`cell-${id}`);
    cell && cell.animate(
      [{ transform:"translateY(0)" }, { transform:"translateY(-2px)" }, { transform:"translateY(0)" }],
      { duration: 160, easing: "ease-out" }
    );

    if (foundIds.size === TOTAL) finish();
    return { ok:true };
  }

  function submit() {
    if (isGivenUp) {
      setToast("warn", "üè≥Ô∏è Partie abandonn√©e. Clique sur ¬´ Recommencer ¬ª pour rejouer.");
      input.value = "";
      return;
    }
    if (isPaused) {
      setToast("warn", "‚è∏Ô∏è Le timer est en pause. Clique sur ¬´ Reprendre ¬ª pour continuer.");
      input.value = "";
      input.focus();
      return;
    }

    const raw = input.value;
    input.value = "";
    input.focus();

    const norm = normalize(raw);
    if (!norm) { setToast("warn", "‚ö†Ô∏è Tape un nom."); return; }

    validate(raw);
  }

  function resetQuiz() {
    foundIds.clear();

    // R√©initialiser l'indice
    isHintActive = false;
    if(btnHint){ btnHint.classList.remove("hint-active"); btnHint.textContent = "üí° Indice"; btnHint.disabled = false; }

    buildGrid();
    updateStats();
    setToast("", "");
    resetTimer();

    input.disabled = false;
    btnSubmit.disabled = false;
    btnGiveUp.disabled = false;

    input.value = "";
    input.focus();
  }

  // Auto-validation (exact match seulement ; √©vite les pr√©fixes et les ambigus)
  let autoT = null;

  function isAnyPrefix(typedKey){
    if (!typedKey) return false;
    for (const k of allKeys) {
      if (k.startsWith(typedKey) && k !== typedKey) return true;
    }
    return false;
  }

  function autoTryValidate() {
    if (isPaused || isFinished || isGivenUp) return;

    const raw = input.value;
    const norm = normalize(raw);
    if (!norm) return;

    // Ne pas auto-valider si ambigu (pr√©nom sans num√©ro) ou si pr√©fixe d'autre chose
    if (ambiguousKeys.has(norm)) return;
    if (isAnyPrefix(norm)) return;

    if (byKey.has(norm)) {
      input.value = "";
      validate(raw);
      input.focus();
      return;
    }
  }

  input.addEventListener("input", () => {
    clearTimeout(autoT);
    autoT = setTimeout(autoTryValidate, 120);
  });

  // --------- Indice ----------
  let isHintActive = false;

  // G√©n√®re le masque "P_ _ _ _ _" pour un nom donn√©
  // Chaque "mot" (s√©par√© par espace ou tiret) est trait√© ind√©pendamment
  function buildHintMask(name) {
    // On extrait la partie avant "‚Äî" (le nom seul, pas le r√®gne)
    const namePart = name.split("‚Äî")[0].trim();
    return namePart.split(/(\s+|-)/).map(token => {
      if (/^\s+$/.test(token)) return token; // espace : conserver
      if (token === "-") return "-";          // tiret : conserver
      if (token.length === 0) return token;
      // Premier caract√®re visible + "_" par lettre restante
      const first = token[0];
      const rest = token.slice(1).replace(/[a-zA-Z√Ä-√ø]/g, "_");
      return first + rest;
    }).join("");
  }

  function applyHints() {
    for (const k of kings) {
      if (foundIds.has(k.id)) continue; // d√©j√† trouv√© : on ne touche pas
      const cell = document.getElementById(`cell-${k.id}`);
      const nameEl = document.getElementById(`name-${k.id}`);
      if (!cell || !nameEl) continue;

      if (isHintActive) {
        const mask = buildHintMask(`${k.king} ‚Äî ${k.reign}`);
        nameEl.textContent = mask;
        nameEl.classList.add("masked", "hinted-text");
        cell.classList.add("hinted");
      } else {
        nameEl.textContent = "??????";
        nameEl.classList.remove("hinted-text");
        nameEl.classList.add("masked");
        cell.classList.remove("hinted");
      }
    }
  }

  function toggleHint() {
    if (isFinished || isGivenUp) return;
    isHintActive = !isHintActive;
    btnHint.classList.toggle("hint-active", isHintActive);
    btnHint.textContent = isHintActive ? "üí° Masquer" : "üí° Indice";
    applyHints();
    if (isHintActive) {
      setToast("warn", "üí° Indices affich√©s : premi√®re lettre + longueur de chaque mot.");
    } else {
      setToast("", "");
    }
  }

  // Quand un monarque est trouv√© avec l'indice actif : retirer le hinting de sa case
  const _origRevealId = revealId;
  // (revealId g√®re d√©j√† la suppression de "masked" ; on s'assure juste de nettoyer hinted-text)
  // On surcharge via un patch post-revealId dans validate ‚Äî voir ci-dessous.

  // Events
  btnSubmit.addEventListener("click", submit);
  document.getElementById("btnReset").addEventListener("click", resetQuiz);
  btnPause.addEventListener("click", togglePause);
  btnGiveUp.addEventListener("click", giveUp);
  btnHint.addEventListener("click", toggleHint);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });

  const btnHome = document.getElementById("btnHome");
  btnHome.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  // init
  buildGrid();
  updateStats();
  input.focus();
</script>
</body>
</html>